{{ config(materialized = 'table', tags=["daily", "genre"], order_by='month, category') }}
with
Idata as (
    select mia.ig_id  profile_id, argMax(mia.followers, mia.updated_at) followers, argMax(mia.primary_category, mia.updated_at) primary_category, max(milb.month)  month
	from dbt.mart_instagram_account mia 
	left join dbt.mart_insta_leaderboard_base milb on mia.ig_id = milb.profile_id 
	group by profile_id
),
base_insta_demography as (
    select 
        CAST((age_groups, age_group_percs), 'Map(String, Float64)') demography, 
        platform_id,
        month,
        if(male_gender<=0 and female_gender<=0 , 0, followers) follow,
        followers*demography['M_13-17'] m_13_17,
        followers*demography['M_18-24'] m_18_24,
        followers*demography['M_25-34'] m_25_34,
        followers*demography['M_35-44'] m_35_44,
        followers*demography['M_45-54'] m_45_54,
        followers*demography['M_55-64'] m_55_64,
        followers*demography['M_65+'] m_65_plus,
        followers*demography['F_13-17'] f_13_17,
        followers*demography['F_18-24'] f_18_24,
        followers*demography['F_25-34'] f_25_34,
        followers*demography['F_35-44'] f_35_44,
        followers*demography['F_45-54'] f_45_54,
        followers*demography['F_55-64'] f_55_64,
        followers*demography['F_65+'] f_65_plus,
        m_13_17 + f_13_17 a_13_17,
        m_18_24 + f_18_24 a_18_24,
        m_25_34 + f_25_34 a_25_34,
        m_35_44 + f_35_44 a_35_44,
        m_45_54 + f_45_54 a_45_54,
        m_55_64 + f_55_64 a_55_64,
        m_65_plus + f_65_plus a_65_plus,
        m_13_17 + m_18_24 + m_25_34 + m_35_44 + m_45_54 + m_55_64 + m_65_plus male_gender,
        f_13_17 + f_18_24 + f_25_34 + f_35_44 + f_45_54 + f_55_64 + f_65_plus female_gender
    from dbt.mart_audience_info 
    left join Idata on Idata.profile_id = platform_id
    where platform = 'INSTAGRAM'
) ,
ia_base as (
    SELECT
        toString(base.month) month,
        COALESCE(IF(account.primary_language in ('en', 'bn', 'ta', 'te', 'mr', 'ka', 'te', 'hi'), account.primary_language, 'MISSING'), 'MISSING') language,
        COALESCE(IF(account.primary_category = '', 'MISSING', account.primary_category), 'MISSING') category,
        'INSTAGRAM'platform,
        COALESCE(account.profile_type, 'CREATOR') profile_type,
        uniqExact(base.profile_id) creator,
        sum(base.plays) views,
        sum(base.likes) likes,
        sum(base.comments) comments,
        sum(base.followers) followers,
        sum(base.uploads) uploads,
        sum(bd.follow) demo_followers,
        sum(m_13_17) m_13_17,
        sum(m_18_24) m_18_24,
        sum(m_25_34) m_25_34,
        sum(m_35_44) m_35_44,
        sum(m_45_54) m_45_54,
        sum(m_55_64) m_55_64,
        sum(m_65_plus) m_65_plus,
        sum(f_13_17) f_13_17,
        sum(f_18_24) f_18_24,
        sum(f_25_34) f_25_34,
        sum(f_35_44) f_35_44,
        sum(f_45_54) f_45_54,
        sum(f_55_64) f_55_64,
        sum(f_65_plus) f_65_plus,
        sum(a_13_17) a_13_17,
        sum(a_18_24) a_18_24 ,
        sum(a_25_34) a_25_34,
        sum(a_35_44) a_35_44,
        sum(a_45_54) a_45_54,
        sum(a_55_64) a_55_64,
        sum(a_65_plus) a_65_plus,
        sum(male_gender) male_gender,
        sum(female_gender) female_gender
    FROM dbt.mart_insta_leaderboard_base base
    left join dbt.mart_instagram_account account ON base.profile_id = account.ig_id
    left join base_insta_demography bd on base.profile_id = bd.platform_id
    where account.country = 'IN' and base.month >= date('2022-01-01')
    group by month, category, language, profile_type, platform with CUBE 
),
ia_final as (
    select
        COALESCE(if(month = '' or month = '1970-01-01', 'ALL', month), 'ALL') month,
        COALESCE(IF(language = '', 'ALL', language), 'ALL') language,
        COALESCE(IF(category = '', 'ALL', category), 'ALL') category,
        COALESCE(IF(platform = '', 'ALL', platform), 'ALL') platform,
        COALESCE(IF(profile_type = '', 'ALL', profile_type), 'ALL') profile_type,
        creator,
        if(views<0, 0, views) views,
        likes,
        comments,
        if(followers<0, 0, followers) followers,
        demo_followers,
        if(uploads<0, 0, uploads) uploads,
        m_13_17,
        m_18_24,
        m_25_34,
        m_35_44,
        m_45_54,
        m_55_64,
        m_65_plus,
        f_13_17,
        f_18_24,
        f_25_34,
        f_35_44,
        f_45_54,
        f_55_64,
        f_65_plus,
        a_13_17,
        a_18_24,
        a_25_34,
        a_35_44,
        a_45_54,
        a_55_64,
        a_65_plus,
        male_gender,
        female_gender
    FROM ia_base
),
fdata as (
    select mya.channel_id profile_id, argMax(mya.followers, mya.updated_at) followers, argMax(mya.category, mya.updated_at) primary_category, max(milb.month)  month
	from dbt.mart_youtube_account mya 
	left join dbt.mart_yt_leaderboard_base milb on mya.channel_id = milb.channel_id
	group by profile_id
),
base_youtube_demography as (
    select 
        CAST((age_groups, age_group_percs), 'Map(String, Float64)') demography, 
        platform_id,
        month,
        if(male_gender<=0 and female_gender<=0, 0, followers) follow,
        followers*demography['M_13-17'] m_13_17,
        followers*demography['M_18-24'] m_18_24,
        followers*demography['M_25-34'] m_25_34,
        followers*demography['M_35-44'] m_35_44,
        followers*demography['M_45-54'] m_45_54,
        followers*demography['M_55-64'] m_55_64,
        followers*demography['M_65+'] m_65_plus,
        followers*demography['F_13-17'] f_13_17,
        followers*demography['F_18-24'] f_18_24,
        followers*demography['F_25-34'] f_25_34,
        followers*demography['F_35-44'] f_35_44,
        followers*demography['F_45-54'] f_45_54,
        followers*demography['F_55-64'] f_55_64,
        followers*demography['F_65+'] f_65_plus,
        m_13_17 + f_13_17 a_13_17,
        m_18_24 + f_18_24 a_18_24,
        m_25_34 + f_25_34 a_25_34,
        m_35_44 + f_35_44 a_35_44,
        m_45_54 + f_45_54 a_45_54,
        m_55_64 + f_55_64 a_55_64,
        m_65_plus + f_65_plus a_65_plus,
        m_13_17 + m_18_24 + m_25_34 + m_35_44 + m_45_54 + m_55_64 + m_65_plus male_gender,
        f_13_17 + f_18_24 + f_25_34 + f_35_44 + f_45_54 + f_55_64 + f_65_plus female_gender
    from dbt.mart_audience_info 
    left join fdata on fdata.profile_id = platform_id
    where platform = 'YOUTUBE'
),
ya_base as (
    SELECT
        toString(base.month) month,
        COALESCE(IF(account.language in ('en', 'bn', 'ta', 'te', 'mr', 'ka', 'te', 'hi'), account.language, 'MISSING'), 'MISSING') language,
        COALESCE(IF(account.category = '', 'MISSING', account.category), 'MISSING') category,
        'YOUTUBE' platform,
        COALESCE(account.profile_type, 'CREATOR') profile_type,
        uniqExact(base.channel_id) creator,
        sum(base.views) views,
        sum(bd.follow) demo_followers,
        sum(0) likes,
        sum(0) comments,
        sum(base.followers_change) followers,
        sum(base.uploads) uploads,
        sum(m_13_17) m_13_17,
        sum(m_18_24) m_18_24,
        sum(m_25_34) m_25_34,
        sum(m_35_44) m_35_44,
        sum(m_45_54) m_45_54,
        sum(m_55_64) m_55_64,
        sum(m_65_plus) m_65_plus,
        sum(f_13_17) f_13_17,
        sum(f_18_24) f_18_24,
        sum(f_25_34) f_25_34,
        sum(f_35_44) f_35_44,
        sum(f_45_54) f_45_54,
        sum(f_55_64) f_55_64,
        sum(f_65_plus) f_65_plus,
        sum(a_13_17) a_13_17 ,
        sum(a_18_24) a_18_24 ,
        sum(a_25_34) a_25_34,
        sum(a_35_44) a_35_44,
        sum(a_45_54) a_45_54,
        sum(a_55_64) a_55_64,
        sum(a_65_plus) a_65_plus,
        sum(male_gender) male_gender,
        sum(female_gender) female_gender
    FROM dbt.mart_yt_leaderboard_base base
    left join dbt.mart_youtube_account account ON base.channel_id = account.channel_id
    left join base_youtube_demography bd on base.channel_id = bd.platform_id
    where account.country = 'IN' and base.month >= date('2022-01-01')
    group by month, category, language, profile_type, platform with CUBE 
),
ya_final as (
    select
        COALESCE(if(month = '' or month='1970-01-01', 'ALL', month), 'ALL') month,
        COALESCE(IF(language = '', 'ALL', language), 'ALL') language,
        COALESCE(IF(category = '', 'ALL', category), 'ALL') category,
        COALESCE(IF(platform = '', 'ALL', platform), 'ALL') platform,
        COALESCE(IF(profile_type = '', 'ALL', profile_type), 'ALL') profile_type,
        language,
        creator,
        if(views<0, 0, views) views,
        toInt64(likes) likes,
        toInt64(comments) comments,
        if(followers<0, 0, followers) followers,
        demo_followers,
        if(uploads<0, 0, uploads) uploads,
        m_13_17,
        m_18_24,
        m_25_34,
        m_35_44,
        m_45_54,
        m_55_64,
        m_65_plus,
        f_13_17,
        f_18_24,
        f_25_34,
        f_35_44,
        f_45_54,
        f_55_64,
        f_65_plus,
        a_13_17,
        a_18_24,
        a_25_34,
        a_35_44,
        a_45_54,
        a_55_64,
        a_65_plus,
        male_gender,
        female_gender
    FROM ya_base
),
conbined as (
    select * from ia_final
        UNION ALL
    select * from ya_final
),
inst_and_yt as (
    select
        month,
        language,
        category,
        profile_type,
        platform,
        sum(creator) creators,
        sum(views) views,
        sum(likes) likes,
        sum(comments) comments,
        sum(followers) followers,
        sum(demo_followers) demo_followers,
        sum(uploads) uploads,
        sum(m_13_17) m_13_17,
        sum(m_18_24) m_18_24,
        sum(m_25_34) m_25_34,
        sum(m_35_44) m_35_44,
        sum(m_45_54) m_45_54,
        sum(m_55_64) m_55_64,
        sum(m_65_plus) m_65_plus,
        sum(f_13_17) f_13_17,
        sum(f_18_24) f_18_24,
        sum(f_25_34) f_25_34,
        sum(f_35_44) f_35_44,
        sum(f_45_54) f_45_54,
        sum(f_55_64) f_55_64,
        sum(f_65_plus) f_65_plus,
        sum(a_13_17) a_13_17,
        sum(a_18_24) a_18_24,
        sum(a_25_34) a_25_34,
        sum(a_35_44) a_35_44,
        sum(a_45_54) a_45_54,
        sum(a_55_64) a_55_64,
        sum(a_65_plus) a_65_plus,
        sum(male_gender) male_gender,
        sum(female_gender) female_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(m_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(m_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(m_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(m_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(m_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(m_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(m_65_plus/demo_followers, 2), 0.0))) male_audience_age_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(f_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(f_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(f_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(f_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(f_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(f_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(f_65_plus/demo_followers, 2), 0.0))) female_audience_age_gender,
        map(
            'male', male_audience_age_gender,
            'female', female_audience_age_gender
        ) audience_age_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(a_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(a_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(a_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(a_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(a_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(a_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(a_65_plus/demo_followers, 2), 0.0))
        ) audience_age,
        map(
            'male_per', if(demo_followers<=0, 0, COALESCE(round(male_gender/demo_followers, 2), 0.0)),
            'female_per', if(demo_followers<=0, 0, COALESCE(round(female_gender/demo_followers, 2), 0.0))
        ) audience_gender
    from conbined
    group by month, language, category, profile_type, platform
),
all as (
    select
        month,
        language,
        category,
        profile_type,
        'ALL' platform,
        sum(creator) creators,
        sum(views) views,
        sum(likes) likes,
        sum(comments) comments,
        sum(followers) followers,
        sum(demo_followers) demo_followers,
        sum(uploads) uploads,
        sum(m_13_17) m_13_17,
        sum(m_18_24) m_18_24,
        sum(m_25_34) m_25_34,
        sum(m_35_44) m_35_44,
        sum(m_45_54) m_45_54,
        sum(m_55_64) m_55_64,
        sum(m_65_plus) m_65_plus,
        sum(f_13_17) f_13_17,
        sum(f_18_24) f_18_24,
        sum(f_25_34) f_25_34,
        sum(f_35_44) f_35_44,
        sum(f_45_54) f_45_54,
        sum(f_55_64) f_55_64,
        sum(f_65_plus) f_65_plus,
        sum(a_13_17) a_13_17,
        sum(a_18_24) a_18_24,
        sum(a_25_34) a_25_34,
        sum(a_35_44) a_35_44,
        sum(a_45_54) a_45_54,
        sum(a_55_64) a_55_64,
        sum(a_65_plus) a_65_plus,
        sum(male_gender) male_gender,
        sum(female_gender) female_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(m_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(m_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(m_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(m_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(m_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(m_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(m_65_plus/demo_followers, 2), 0.0))) male_audience_age_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(f_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(f_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(f_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(f_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(f_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(f_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(f_65_plus/demo_followers, 2), 0.0))) female_audience_age_gender,
        map(
            'male', male_audience_age_gender,
            'female', female_audience_age_gender
        ) audience_age_gender,
        map(
            '13-17', if(demo_followers<=0, 0, COALESCE(round(a_13_17/demo_followers, 2), 0.0)),
            '18-24', if(demo_followers<=0, 0, COALESCE(round(a_18_24/demo_followers, 2), 0.0)),
            '25-34', if(demo_followers<=0, 0, COALESCE(round(a_25_34/demo_followers, 2), 0.0)),
            '35-44', if(demo_followers<=0, 0, COALESCE(round(a_35_44/demo_followers, 2), 0.0)),
            '45-54', if(demo_followers<=0, 0, COALESCE(round(a_45_54/demo_followers, 2), 0.0)),
            '55-64', if(demo_followers<=0, 0, COALESCE(round(a_55_64/demo_followers, 2), 0.0)),
            '65+', if(demo_followers<=0, 0, COALESCE(round(a_65_plus/demo_followers, 2), 0.0))
        ) audience_age,
        map(
            'male_per', if(demo_followers<=0, 0, COALESCE(round(male_gender/demo_followers, 2), 0.0)),
            'female_per', if(demo_followers<=0, 0, COALESCE(round(female_gender/demo_followers, 2), 0.0))
        ) audience_gender
    from conbined
    group by month, language, category, profile_type
),
final as (
    select
        month,
        language,
        category,
        profile_type,
        platform,
        creators,
        views,
        likes,
        comments,
        likes + comments engagement,
        1.0*engagement / views engagement_rate,
        followers,
        demo_followers,
        uploads,
        m_13_17,
        m_18_24,
        m_25_34,
        m_35_44,
        m_45_54,
        m_55_64,
        m_65_plus,
        f_13_17,
        f_18_24,
        f_25_34,
        f_35_44,
        f_45_54,
        f_55_64,
        f_65_plus,
        a_13_17,
        a_18_24,
        a_25_34,
        a_35_44,
        a_45_54,
        a_55_64,
        a_65_plus,
        male_gender,
        female_gender,
        male_audience_age_gender,
        female_audience_age_gender,
        male_audience_age_gender,
        female_audience_age_gender,
        audience_age_gender,
        audience_age,
        audience_gender
    from inst_and_yt
    union all
    select
        month,
        language,
        category,
        profile_type,
        platform,
        creators,
        views,
        likes,
        comments,
        likes + comments engagement,
        1.0*engagement / views engagement_rate,
        followers,
        demo_followers,
        uploads,
        m_13_17,
        m_18_24,
        m_25_34,
        m_35_44,
        m_45_54,
        m_55_64,
        m_65_plus,
        f_13_17,
        f_18_24,
        f_25_34,
        f_35_44,
        f_45_54,
        f_55_64,
        f_65_plus,
        a_13_17,
        a_18_24,
        a_25_34,
        a_35_44,
        a_45_54,
        a_55_64,
        a_65_plus,
        male_gender,
        female_gender,
        male_audience_age_gender,
        female_audience_age_gender,
        male_audience_age_gender,
        female_audience_age_gender,
        audience_age_gender,
        audience_age,
        audience_gender
    from all
)
select * from final
SETTINGS
    max_bytes_before_external_group_by = 40000000000,
    max_bytes_before_external_sort = 40000000000,
    join_algorithm='partial_merge'