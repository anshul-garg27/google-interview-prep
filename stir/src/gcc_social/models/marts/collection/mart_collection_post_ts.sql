{{ config(materialized = 'table', tags=["collections"], order_by='collection_id,post_short_code,stats_date') }}
with
profile_collection_post_ts as (
    SELECT
            platform,
            post_short_code,
            post_collection_item_id,
            post_type,
            post_title,
            post_link,
            post_thumbnail,
            hashtags,
            keywords,
            published_at,
            profile_social_id,
            profile_handle,
            post_handle,
            profile_name,
            collection_type,
            collection_id,
            followers,
            link_clicks,
            orders,
            delivered_orders,
            completed_orders,
            leaderboard_overall_orders,
            leaderboard_delivered_orders,
            leaderboard_completed_orders,
            stats_date,
            views,
            likes,
            comments,
            impressions,
            saves,
            plays,
            reach,
            swipe_ups,
            mentions,
            sticker_taps,
            shares,
            story_exits,
            story_back_taps,
            story_forward_taps,
            total_engagement,
            engagement_rate,
            real_reach,
            real_impressions,
            updated_at
    FROM
        {{ ref('mart_profile_collection_post_ts') }}
),
post_collection_post_ts as (
    SELECT
            platform,
            post_short_code,
            post_collection_item_id,
            post_type,
            post_title,
            post_link,
            post_thumbnail,
            hashtags,
            keywords,
            published_at,
            profile_social_id,
            profile_handle,
            post_handle,
            profile_name,
            collection_type,
            collection_id,
            followers,
            link_clicks,
            orders,
            delivered_orders,
            completed_orders,
            leaderboard_overall_orders,
            leaderboard_delivered_orders,
            leaderboard_completed_orders,
            stats_date,
            views,
            likes,
            comments,
            impressions,
            saves,
            plays,
            reach,
            swipe_ups,
            mentions,
            sticker_taps,
            shares,
            story_exits,
            story_back_taps,
            story_forward_taps,
            total_engagement,
            engagement_rate,
            real_reach,
            real_impressions,
            updated_at
    FROM
        {{ ref('mart_post_collection_post_ts') }}
)
select * from profile_collection_post_ts
    union all
select * from post_collection_post_ts
SETTINGS max_bytes_before_external_group_by = 20000000000, max_bytes_before_external_sort = 20000000000, join_algorithm='partial_merge'
