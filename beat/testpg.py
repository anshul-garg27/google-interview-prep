
from sqlalchemy import text
from sqlalchemy.ext.asyncio import create_async_engine, AsyncConnection
import asyncio

import uvloop

from instagram.entities.entities import InstagramPost
from utils.db import get_or_create


shortcode_existed = [
    "3288070164107830564",
"3288074573981025121",
"3323528241276929862",
"3324242021354087635",
"3324243170450991936",
"3324243262404832632",
"3324243616725596631",
"3324243802187037794",
"3324243955691668695",
"3324244095345246027",
"3324244785868594511",
"3324245010533451889",
"3324245114400929379",
"3324245511877567232",
"3324245535644969901",
"3324245559484584506",
"3324245670332275777",
"3324246193921748674",
"3324246315723997468",
"3324246407178476896",
"3324246525036797658",
"3324246705727253443",
"3324246803892447964",
"3324247281153927907",
"3324247503626733663",
"3324247581424294667",
"3324247786895655222",
"3324248006188159674",
"3324248290631542289",
"3324249076425220540",
"3324249365203081774",
"3324250163358919368",
"3324250417075638639",
"3324250669900027010",
"3324250947025997907",
"3324251112173113259",
"3324251197140686338",
"3324251254360360443",
"3324251303993326565",
"3324251400656339707",
"3324251474105529738",
"3324251477505676459",
"3324252074405425860",
"3324252249349687102",
"3324252400075458415",
"3324253136831018080",
"3324253429106897976",
"3324253751354894943",
"3324253781813492579",
"3324254097384589821",
"3324254156168138130",
"3324254380651051801",
"3324254394014132196",
"3324254919349012467",
"3324255042403153777",
"3324255162477831964",
"3324255196493401353",
"3324255739041737291",
"3324256126605708022",
"3324256447678820269",
"3324256591324640928",
"3324256606364895539",
"3324256701736486994",
"3324256783180128253",
"3324258007665974402",
"3324258156934688047",
"3324258463185320544",
"3324258506294892937",
"3324258718928858283",
"3324258869354124343",
"3324258969857287684",
"3324259125298902880",
"3324259199577674406",
"3324259257083536375",
"3324259446940859662",
"3324259860307921879",
"3324259946366579768",
"3324260052749347901",
"3324260084476679266",
"3324260217847985214",
"3324260299754217385",
"3324260387406876158",
"3324260397724147126",
"3324260568407850482",
"3324260758451077985",
"3324260959844629752",
"3324260993566943649",
"3324261222054913739",
"3324261256715769681",
"3324261731772881424",
"3324261936522744228",
"3324262088423637599",
"3324262421599700289",
"3324262477494872305",
"3324262599902326685",
"3324262821445374702",
"3324263155077033705",
"3324263385804065729",
"3324264148396510401",
"3324264308625515814",
"3324264628083177732",
"3324265407609743616",
"3324265616637320041",
"3324265695162641716",
"3324265828070991783",
"3324266540282989133",
"3324266547696859456",
"3324266816469240230",
"3324267259916343587",
"3324267354191692554",
"3324267866678840060",
"3324268951278043961",
"3324268992062683706",
"3324269638523271852",
"3324269790916495948",
"3324269892452799584",
"3324270188888982943",
"3324270451812957920",
"3324270647864026193",
"3324270976093444089",
"3324271510750748718",
"3324271893009460349",
"3324272369055746280",
"3324272396771621823",
"3324272439411561898",
"3324272691655763949",
"3324273010865150996",
"3324273149038285110",
"3324273155822862105",
"3324273540945535831",
"3324273777677951560",
"3324273838899767360",
"3324273958067553945",
"3324273959335685640",
"3324274881084435118",
"3324275050760503070",
"3324275448371556292",
"3324275551753433105",
"3324275650755254651",
"3324275991165007706",
"3324276371169733855",
"3324276665567927998",
"3324277756841011946",
"3324278231360233409",
"3324278250800496494",
"3324278254269333115",
"3324278254420242426",
"3324278855606723416",
"3324279389732480941",
"3324279692686883005",
"3324279846007170536",
"3324280022000639979",
"3324280331311556276",
"3324280826241952880",
"3324281297754471902",
"3324281530615640042",
"3324281615297177439",
"3324281971538498237",
"3324281985278314475",
"3324281995647355453",
"3324282113472242867",
"3324282313053047742",
"3324282561370589155",
"3324283030151147563",
"3324283253561210100",
"3324283319259937441",
"3324283601218669636",
"3324283770731129852",
"3324283875677084877",
"3324284235941737926",
"3324284402338351521",
"3324284419464072849",
"3324286044157281149",
"3324286237292103327",
"3324286259666875527",
"3324286458789580672",
"3324287163698681572",
"3324287691611048139",
"3324288912885017443",
"3324289396844731612",
"3324290298118757435",
"3324290533185864151",
"3324290958371420323",
"3324291388086237854",
"3324291965860284903",
"3324292448180175712",
"3324293416182645094",
"3324294465899627288",
"3324294509520807747",
"3324295064477925073",
"3324295140291866085",
"3324295185265470589",
"3324297193715940173",
"3324297567034267780",
"3324298094392752823",
"3324298486182666317",
"3324298691442646177",
"3324298738175172354",
"3324298952760891368",
"3324299787264300208",
"3324300874343838480",
"3324300961406592996",
"3324301321153827085",
"3324301518252644764",
"3324301906620735497",
"3324302825584572904",
"3324303018219613817",
"3324303069533469658",
"3324303118405694809",
"3324303183827560289",
"3324304403589955810",
"3324304567360283976",
"3324305285106632371",
"3324305551185783066",
"3324306168351727955",
"3324306303551758174",
"3324306425502770767",
"3324307911980817688",
"3324308015331119192",
"3324308415408880837",
"3324308948185939931",
"3324309019421436348",
"3324309198695255815",
"3324309548684799518",
"3324309812338651903",
"3324310199503692739",
"3324311740390557306",
"3324311755307288466",
"3324312159747995581",
"3324312327327091086",
"3324313422818428668",
"3324313801723335292",
"3324313998211808006",
"3324314272021944479",
"3324314982763974709",
"3324315654014321554",
"3324315821895543260",
"3324316315555817354",
"3324316393502674993",
"3324317187928216436",
"3324317596655735009",
"3324317976173747755",
"3324317996473460226",
"3324318000920214544",
"3324318070226056567",
"3324318087389367402",
"3324318408807825829",
"3324318785934521438",
"3324319002368697574",
"3324319039580944987",
"3324319117896172584",
"3324319150946583426",
"3324319836297077758",
"3324320414817552416",
"3324320479014835145",
"3324320595514905830",
"3324321590825029368",
"3324322144280143624",
"3324322249906879880",
"3324322411278641208",
"3324322603526828491",
"3324323432568290635",
"3324323572633798691",
"3324323847318363915",
"3324324065822678891",
"3324325300216913375",
"3324325393992589978",
"3324325879207008239",
"3324326110361187866",
"3324326744725274420",
"3324330748179902170",
"3324331242696456860",
"3324331935119521876",
"3324332125230557384",
"3324332287891391362",
"3324332491734800830",
"3324333864684038495",
"3324335389730473896",
"3324335785741616941",
"3324335811142306314",
"3324335914876638321",
"3324335978285243287",
"3324336772233304874",
"3324337521143953556",
"3324337591857450668",
"3324338400387597873",
"3324338509329475287",
"3324339073313301313",
"3328616850774371396",
"3329268748644079967",
"3329268954643160299",
"3329269322634678515",
"3329269492529037374",
"3329269702335554655",
"3329269820096721720",
"3329270674341235384",
"3329270696446152812",
"3329271109568368615",
"3329271144287040777",
"3329271264430118234",
"3329271293664672471",
"3329272241585773961",
"3329272367984531514",
"3329273013018153733",
"3329273543555618303",
"3329273581521405181",
"3329273875500352187",
"3329273879140341537",
"3329274055562037898",
"3329274114710846504",
"3329274265596597705",
"3329274351832317296",
"3329274556411948384",
"3329275608538161665",
"3329276277432805870",
"3329276772063306608",
"3329277121614999326",
"3329277180327005435",
"3329277396041564822",
"3329277641727049942",
"3329277667102452742",
"3329277755918624420",
"3329277815084118774",
"3329278378655311599",
"3329278778054312324",
"3329278801887504201",
"3329278913607810905",
"3329278965681554913",
"3329279003054639221",
"3329279166859038482",
"3329279381170067130",
"3329279446761798795",
"3329279705089649227",
"3329279970118597149",
"3329280144365977558",
"3329280589028639997",
"3329280698779087804",
"3329280832046957071",
"3329281010365330108",
"3329282151878594676",
"3329282253027953890",
"3329282357296863073",
"3329282542326523525",
"3329282714041510840",
"3329282771016101536",
"3329283020442548444",
"3329283110277300639",
"3329283113363634628",
"3329283228296578329",
"3329283443161740266",
"3329283480374043165",
"3329283745395683461",
"3329283841134712163",
"3329284126422205997",
"3329284282567720791",
"3329284403245623563",
"3329284526013417617",
"3329284762520839101",
"3329285448164806788",
"3329285448618665416",
"3329285499554173488",
"3329285909310216533",
"3329286062752838814",
"3329286173124124546",
"3329286219489756576",
"3329286534313321534",
"3329286771485404487",
"3329286992130690147",
"3329287249912071293",
"3329287333864512944",
"3329287684551564467",
"3329287716006544222",
"3329287919147405295",
"3329288059874113607",
"3329288069721344093",
"3329288862824017294",
"3329288949553107164",
"3329289261995886541",
"3329289275535013787",
"3329289566048031209",
"3329289717815381398",
"3329289758693124182",
"3329289806836042052",
"3329289914302344200",
"3329290568260089666",
"3329290964270959048",
"3329291460875737661",
"3329291547487734231",
"3329291560639929965",
"3329292126135015337",
"3329292239053963511",
"3329292793163691324",
"3329292794531099986",
"3329292874088293709",
"3329293085093242222",
"3329293360398734908",
"3329293845764752788",
"3329294103195764042",
"3329294265489351788",
"3329294570908442540",
"3329294764417929968",
"3329294964362032841",
"3329295106481803849",
"3329295215658685133",
"3329296294408084161",
"3329296319700666274",
"3329296406092460038",
"3329296508356212142",
"3329296641134305799",
"3329297168373670060",
"3329297472614358859",
"3329299359904047519",
"3329299661252619414",
"3329299809227580969",
"3329300063327034365",
"3329300081906235233",
"3329302047031237579",
"3329302083857024171",
"3329302397959567868",
"3329302456537412303",
"3329303035233122091",
"3329303189256522271",
"3329303375224071706",
"3329303692790115635",
"3329303731301850076",
"3329303978329918009",
"3329304085159554225",
"3329304108093069170",
"3329304573535923143",
"3329304687203051321",
"3329304896573606267",
"3329305589314049982",
"3329306405458240188",
"3329306530050209558",
"3329307753429762278",
"3329307908135003734",
"3329308038500862569",
"3329309419912951579",
"3329309919386894038",
"3329310472103259583",
"3329311450400662396",
"3329312596894633092",
"3329313173998181733",
"3329314214571192322",
"3329316203595610139",
"3329316327100615958",
"3329316527276985455",
"3329318663215327780",
"3329318999073583323",
"3329319367921410087",
"3329323754559467614",
"3329324061716883801",
"3329324650546796676",
"3329327226863095823",
"3329327532150955085",
"3329327606372759966",
"3329327801374902410",
"3329329852353367036",
"3329332762162975865",
"3329335028873018196",
"3329338780921142645",
"3329338967575542881",
"3329339300838045478",
"3329342824449258604",
"3329349290972902395",
"3329350556900293439",
"3329353838144582117",
"3329353914641149318",
"3329354025363202104",
"3329354993005148158",
"3329356615219389984",
"3329360281368165779",
"3329364564406699753",
"3329365424096010693",
"3329367947457393937",
"3329368248530945458",
"3329369953047168702",
"3329370022949425515",
"3329374883267127668",
"3329377455734462363",
"3329379055560258007",
"3329379606287555758",
"3329387116533524803",
"3329389850649295108",
"3329390425093479435",
"3329398442513991368",
"3329404204638224566",
"3329404207383479527",
"3329405902375060433",
"3329412353564903324",
"3329416053855319487",
"3329417273210289949",
"3329417424943357651",
"3329420010354936128",
"3329426505811948881",
"3329428346668399538",
"3329446870281054184",
"3329456268871296184",
"3329459891215031262",
"3329462573396212336",
"3329466756032505026",
"3329472649667240603",
"3329492346756158515",
"3329496324734727224",
"3329501753070303866",
"3329504768086943686",
"3329511004806428507",
"3329527608890091232",
"3329536459442673614",
"3329556120590437112",
"3329558958216890118",
"3329559936388260556",
"3329563090857091616",
"3329588105560357407",
"3329618852040037003",
"3329631554736992718",
"3329725727612020627",
"3329748897949598028",
"3329786625044791459",
"3329792315702885588",
"3329800831649170872",
"3329809172148864963",
"3329822733894025249",
"3329840569551326133",
"3329849154771448373",
"3329906211933907444",
"3329925526319442209",
"3329932128228063526",
"3329937395653917279",
"3329943403382929157",
"3329975918096487683",
"3330075587191457402",
"3330124664952153933",
"3330130332111768216",
"3330134195894185270",
"3330158866762829118",
"3330204123122210315",
"3330269757139519011",
"3330737948792695723",
"3330784150452848964",
"3330927928468549976",
"3330975205093671689"
]

import clickhouse_connect
import os
from datetime import datetime


async def insertintopg():
    
    cliclhouse_query = "select short_code, post_type, posted_by_handle handle, sponsor_links, post_title, post_thumbnail thumbnail, created_at, updated_at  from dbt.stg_coffee_post_collection_item where post_collection_id in ('2f06f1ec-9312-43e8-af62-8b2de4f1ee5f', '1b6e6c53-f0ec-4da6-a3f4-31efc51156f3')"
    client = clickhouse_connect.get_client(host='ec2-52-66-200-31.ap-south-1.compute.amazonaws.com',
                                           username='beat',
                                           password='kZx89Â£;\~U29')
    result = client.query(cliclhouse_query)
    
    for row in result.result_rows:
        print(row)
    
    engine = create_async_engine('postgresql+asyncpg://gccuser:dbBeat123UseRpr0d@pg-master:5432/beat', isolation_level="AUTOCOMMIT", echo=False, pool_size=5, max_overflow=5)
    conn = await engine.connect()
    session = conn
    shortcode = '3330784150452848964'
    post: InstagramPost = (await get_or_create(session, InstagramPost, shortcode=shortcode))[0]
    # post.updated_at = datetime.now()
    statement = text("""
            SELECT * from instagram_post where shortcode = '3330784150452848964'
        """)
    rs = await conn.execute(statement)
    for row in rs:
        print(row)


with asyncio.Runner(loop_factory=uvloop.new_event_loop) as runner:
    runner.run(insertintopg())

